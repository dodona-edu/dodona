<% content_for :javascripts do %>
  <%= javascript_include_tag 'score_item' %>
<% end %>
<% maximum_score = evaluation_exercise.maximum_score %>
<div id="score-items-<%= evaluation_exercise.id %>" class="mb-2">
  <div class="d-flex flex-row align-items-center">
    <h4><%= evaluation_exercise.exercise.name %></h4>
    <div class="flex-spacer"></div>
    <div class="dropdown">
      <a class="btn btn-icon dropdown-toggle" data-bs-toggle="dropdown">
        <i class="mdi mdi-dots-vertical"></i>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <%= link_to evaluation_evaluation_exercise_score_items_path(evaluation_exercise.evaluation_id, evaluation_exercise.id, format: :csv), class: "dropdown-item" do %>
            <i class="mdi mdi-download mdi-18"></i>
            <%= I18n.t "score_items.exercise.download" %>
          <% end %>
        </li>
        <li>
          <a href="#upload-form-<%=evaluation_exercise.id%>" data-bs-toggle="modal" class="dropdown-item">
            <i class="mdi mdi-upload mdi-18"></i>
            <%= I18n.t "score_items.exercise.upload" %>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <table class="table table-resource score-items-table" id="table-for-<%= evaluation_exercise.id %>">
    <thead>
    <tr>
      <th><%= ScoreItem.human_attribute_name(:name) %></th>
      <th><%= ScoreItem.human_attribute_name(:description) %></th>
      <th><%= ScoreItem.human_attribute_name(:maximum) %></th>
      <th><%= ScoreItem.human_attribute_name(:visible) %></th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <% if evaluation_exercise.score_items.empty? %>
      <tr>
        <td class="placeholder-text" colspan="5"><%= t 'score_items.exercise.nothing' %></td>
      </tr>
    <% else %>
      <% evaluation_exercise.score_items.each do |score_item| %>
        <tr>
          <td class="name"><%= score_item.name %></td>
          <td class="description"><%= markdown score_item.description %></td>
          <td class="maximum"><%= format_score score_item.maximum %></td>
          <td class="visibility">
            <%= form_for [@evaluation, score_item], namespace: "#{evaluation_exercise.id}_#{score_item.id}", method: :patch, remote: :true do |f| %>
              <%= f.check_box :visible, class: "form-check-input visibility-checkbox", title: t(".visibility") %>
            <% end %>
          </td>
          <td class="actions">
            <%= link_to "#edit-form-#{score_item.id}", title: t('.edit_title'), class: 'btn btn-icon edit-button',
                        data: { "bs-toggle": "modal" } do %>
              <i class="mdi mdi-pencil" aria-hidden='true'></i>
            <% end %>
            <%= button_to evaluation_score_item_path(@evaluation, score_item),
                          title: t('.delete_title'),
                          method: :delete,
                          remote: true,
                          data: { confirm: t('general.are_you_sure') },
                          class: 'btn btn-icon btn-icon-filled d-btn-danger' do %>
              <i class="mdi mdi-delete" aria-hidden='true'></i>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
    <tr class="maximum-row">
      <td colspan="2" class="wide-description"><%= t '.max' %></td>
      <td class="maximum">
        <%= format_score maximum_score %>
      </td>
      <td class="visibility">
        <%= form_for evaluation_exercise, namespace: evaluation_exercise.id, method: :patch, remote: :true do |f| %>
          <%= f.check_box :visible_score,
                          class: "form-check-input total-visibility-checkbox",
                          disabled: maximum_score.nil?,
                          title: t(".total_visibility") %>
        <% end %>
      </td>
      <td class="actions">
        <%= link_to "#copy-form-#{evaluation_exercise.id}",
                    class: 'btn btn-icon',
                    title: t('.copy_title', name: evaluation_exercise.exercise.name),
                    data: { "bs-toggle": 'modal' } do %>
          <i class="mdi mdi-content-copy" aria-hidden='true'></i>
        <% end %>
        <%= link_to "#new-form-#{evaluation_exercise.id}",
                    class: 'btn btn-icon btn-icon-filled bg-primary',
                    title: t('.add_title', name: evaluation_exercise.exercise.name),
                    data: { "bs-toggle": 'modal' } do %>
          <i class="mdi mdi-plus" aria-hidden='true'></i>
        <% end %>
      </td>
    </tr>
    </tbody>

  </table>
  <% evaluation_exercise.score_items.each do |score_item| %>
    <div class="modal fade modal-<%= evaluation_exercise.id %>" id="edit-form-<%= score_item.id %>" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <%= render 'score_items/form',
                   models: [@evaluation, score_item],
                   evaluation_exercise: evaluation_exercise,
                   title: t('.edit_item_title', title: score_item.name),
                   form_options: {namespace: evaluation_exercise.id, remote: true} %>
      </div>
    </div>
  <% end %>
  <div class="modal fade modal-<%= evaluation_exercise.id %>" id="new-form-<%= evaluation_exercise.id %>" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <%= render 'score_items/form',
                 models: [@evaluation, new || ScoreItem.new],
                 evaluation_exercise: evaluation_exercise,
                 title: t('.add_title', name: evaluation_exercise.exercise.name),
                 form_options: {namespace: evaluation_exercise.id, remote: true} %>
    </div>
  </div>
  <div class="modal fade modal-<%= evaluation_exercise.id %>" id="copy-form-<%= evaluation_exercise.id %>" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <%= render 'score_items/copy', evaluation_exercise: evaluation_exercise, evaluation: @evaluation %>
    </div>
  </div>
  <div class="modal fade modal-<%= evaluation_exercise.id %>" id="upload-form-<%= evaluation_exercise.id %>" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <%= render partial: 'score_items/upload', locals: {evaluation_exercise: evaluation_exercise} %>
    </div>
  </div>
</div>
<script>
    window.dodona.initVisibilityCheckboxes(document.getElementById("score-items-<%= evaluation_exercise.id %>"));
</script>
